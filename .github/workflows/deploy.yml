name: Deploy Library System to AWS

on:
  push:
    branches:
      - production # Faqat "production" branch'iga kod qo'shilganda ishga tushadi
  workflow_dispatch: # GitHub Actions bo'limidan qo'lda ishga tushirishga ruxsat beradi

jobs:
  # ==================================
  # === FRONTEND DEPLOYMENT VAZIFASI ===
  # ==================================
  deploy-frontend:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend

    steps:
      - name: Kodni yuklab olish
        uses: actions/checkout@v3

      - name: Node.js'ni sozlash
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Qaramliklarni o'rnatish
        run: npm install

      - name: Qurish uchun .env faylini yaratish
        run: |
          echo "VITE_API_URL=https://api.library.manabi.uz/api/v1" >> .env
          echo "VITE_SOCKET_URL=https://api.library.manabi.uz" >> .env

      - name: Loyihani qurish
        run: npm run build

      - name: AWS hisob ma'lumotlarini sozlash
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: S3'ga deploy qilish
        run: aws s3 sync ./dist/ s3://${{ secrets.S3_BUCKET_NAME }}/ --delete

      - name: CloudFront keshini tozalash
        run: aws cloudfront create-invalidation --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} --paths "/*"

  # ==================================
  # === BACKEND DEPLOYMENT VAZIFASI ===
  # ==================================
  deploy-backend:
    runs-on: ubuntu-latest
    needs: deploy-frontend # Frontend deploy'i muvaffaqiyatli tugagandan so'ng boshlanadi

    steps:
      - name: Kodni yuklab olish
        uses: actions/checkout@v3

      - name: SSH kalitini sozlash
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: rsync uchun .env faylini yaratish
        run: echo "${{ secrets.ENV_FILE_PRODUCTION }}" > ./backend/.env

      - name: Fayllarni EC2'ga rsync orqali deploy qilish
        run: |
          rsync -avz --delete --exclude 'node_modules' --exclude 'dist' --exclude '.git' \
          -e "ssh -o StrictHostKeyChecking=no" \
          ./backend/ ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/backend/

      - name: EC2'da masofaviy buyruqlarni bajarish
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd ~/backend
            echo "Backend xizmatlari qayta ishga tushirilmoqda..."
            sudo docker-compose -f docker-compose.prod.yml up -d --build --force-recreate
            echo "Eski Docker image'lar tozalanmoqda..."
            sudo docker image prune -a -f
